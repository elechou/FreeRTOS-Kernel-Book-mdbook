<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Chapter Introduction and Scope - Mastering the FreeRTOS</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Mastering the FreeRTOS</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="81-chapter-introduction-and-scope"><a class="header" href="#81-chapter-introduction-and-scope">8.1 Chapter Introduction and Scope</a></h2>
<p>In a multitasking system there is potential for error if one task starts
to access a resource, but does not complete its access before being
transitioned out of the Running state. If the task leaves the resource
in an inconsistent state, then access to the same resource by any other
task or interrupt could result in data corruption, or other similar
issue.</p>
<p>Following are some examples:</p>
<ul>
<li>
<p>Accessing Peripherals</p>
<p>Consider the following scenario where two tasks attempt to write to an
Liquid Crystal Display (LCD).</p>
<ol>
<li>
<p>Task A executes and starts to write the string "Hello world" to the
LCD.</p>
</li>
<li>
<p>Task A is pre-empted by Task B after outputting just the beginning
of the string—"Hello w".</p>
</li>
<li>
<p>Task B writes "Abort, Retry, Fail?" to the LCD before entering the
Blocked state.</p>
</li>
<li>
<p>Task A continues from the point at which it was pre-empted, and
completes outputting the remaining characters of its string—"orld".</p>
</li>
</ol>
<p>The LCD now displays the corrupted string "Hello wAbort, Retry, Fail?orld".</p>
</li>
<li>
<p>Read, Modify, Write Operations</p>
<p>Listing 8.1 shows a line of C code, and an example of how the C code
would typically be translated into assembly code. It can be seen that
the value of PORTA is first read from memory into a register, modified
within the register, and then written back to memory. This is called a
read, modify, write operation.</p>
<p><a name="list8.1" title="Listing 8.1 An example read, modify, write sequence"></a></p>
<pre><code class="language-c">/* The C code being compiled. */
PORTA |= 0x01;

/* The assembly code produced when the C code is compiled. */
LOAD  R1,[#PORTA] ; Read a value from PORTA into R1
MOVE  R2,#0x01    ; Move the absolute constant 1 into R2
OR    R1,R2       ; Bitwise OR R1 (PORTA) with R2 (constant 1)
STORE R1,[#PORTA] ; Store the new value back to PORTA
</code></pre>
<p><em><strong>Listing 8.1</strong></em> <em>An example read, modify, write sequence</em></p>
<p>This is a 'non-atomic' operation because it takes more than one
instruction to complete, and can be interrupted. Consider the following
scenario where two tasks attempt to update a memory mapped register
called PORTA.</p>
<ol>
<li>
<p>Task A loads the value of PORTA into a register—the read portion of
the operation.</p>
</li>
<li>
<p>Task A is pre-empted by Task B before it completes the modify and
write portions of the same operation.</p>
</li>
<li>
<p>Task B updates the value of PORTA, then enters the Blocked state.</p>
</li>
<li>
<p>Task A continues from the point at which it was pre-empted. It
modifies the copy of the PORTA value that it already holds in a
register, before writing the updated value back to PORTA.</p>
</li>
</ol>
<p>In this scenario, Task A updates and writes back an out of date value
for PORTA. Task B modifies PORTA after Task A takes a copy of the PORTA
value, and before Task A writes its modified value back to the PORTA
register. When Task A writes to PORTA, it overwrites the modification
that has already been performed by Task B, effectively corrupting the
PORTA register value.</p>
<p>This example uses a peripheral register, but the same principle applies
when performing read, modify, write operations on variables.</p>
</li>
</ul>
<ul>
<li>
<p>Non-atomic Access to Variables</p>
<p>Updating multiple members of a structure, or updating a variable that is
larger than the natural word size of the architecture (for example,
updating a 32-bit variable on a 16-bit machine), are examples of
non-atomic operations. If they are interrupted, they can result in data
loss or corruption.</p>
</li>
<li>
<p>Function Reentrancy</p>
<p>A function is 'reentrant' if it is safe to call the function from more
than one task, or from both tasks and interrupts. Reentrant functions
are said to be 'thread safe' because they can be accessed from more than
one thread of execution without the risk of data or logical operations
becoming corrupted.</p>
<p>Each task maintains its own stack and its own set of processor
(hardware) register values. If a function does not access any data other
than data stored on the stack or held in a register, then the function
is reentrant, and thread safe. Listing 8.2 is an example of a reentrant
function. Listing 8.3 is an example of a function that is not reentrant.</p>
<p>If an application uses the newlib C Library, it must set <code>configUSE_NEWLIB_REENTRANT</code> to 1
in FreeRTOSConfig.h to ensure that the Thread Local Storage required by newlib is
allocated correctly.</p>
<p>If an application uses the picolibc C Library, it must set <code>configUSE_PICOLIBC_TLS</code> to 1 in
FreeRTOSConfig.h to ensure that the Thread Local Storage required by picolibc is
allocated correctly.</p>
<p>If an application uses any other C library and it requires Thread Local Storage (TLS), it
must set <code>configUSE_C_RUNTIME_TLS_SUPPORT</code> to 1 in FreeRTOSConfig.h and must implement
the following macros-</p>
<ul>
<li><code>configTLS_BLOCK_TYPE</code> - Type of the per task TLS block.</li>
<li><code>configINIT_TLS_BLOCK</code> - Initialize per task TLS block.</li>
<li><code>configSET_TLS_BLOCK</code> - Update current TLS block. Called during context switch to ensure
that the correct TLS block is used.</li>
<li><code>configDEINIT_TLS_BLOCK</code> - Free the TLS block.</li>
</ul>
<p><a name="list8.2" title="Listing 8.2 An example of a reentrant function"></a></p>
<pre><code class="language-c">/* A parameter is passed into the function. This will either be passed on the 
   stack, or in a processor register. Either way is safe as each task or 
   interrupt that calls the function maintains its own stack and its own set 
   of register values, so each task or interrupt that calls the function will 
   have its own copy of lVar1. */
long lAddOneHundred( long lVar1 )
{
    /* This function scope variable will also be allocated to the stack or a 
       register, depending on the compiler and optimization level. Each task
       or interrupt that calls this function will have its own copy of lVar2. */
    long lVar2;

    lVar2 = lVar1 + 100;
    return lVar2;
}
</code></pre>
<p><em><strong>Listing 8.2</strong></em> <em>An example of a reentrant function</em></p>
<p><a name="list8.3" title="Listing 8.3 An example of a function that is not reentrant"></a></p>
<pre><code class="language-c">/* In this case lVar1 is a global variable, so every task that calls
   lNonsenseFunction will access the same single copy of the variable. */
long lVar1;

long lNonsenseFunction( void )
{
    /* lState is static, so is not allocated on the stack. Each task that
       calls this function will access the same single copy of the variable. */
    static long lState = 0;
    long lReturn;

    switch( lState )
    {
        case 0 : lReturn = lVar1 + 10;
                 lState = 1;
                 break;

        case 1 : lReturn = lVar1 + 20;
                 lState = 0;
                 break;
    }
}
</code></pre>
<p><em><strong>Listing 8.3</strong></em> <em>An example of a function that is not reentrant</em></p>
</li>
</ul>
<h3 id="811-mutual-exclusion"><a class="header" href="#811-mutual-exclusion">8.1.1 Mutual Exclusion</a></h3>
<p>To ensure data consistency is maintained at all times, access to a
resource that is shared between tasks, or is shared between tasks and interrupts,
must be managed using a 'mutual exclusion' technique. The goal is to
ensure that, once a task starts to access a shared resource that is not
re-entrant and not thread-safe, the same task has exclusive access to
the resource until the resource has been returned to a consistent state.</p>
<p>FreeRTOS provides several features that can be used to implement mutual
exclusion, but the best mutual exclusion method is to (whenever
possible, as it is often not practical) design the application in such a
way that resources are not shared, and each resource is accessed only
from a single task.</p>
<h3 id="812-scope"><a class="header" href="#812-scope">8.1.2 Scope</a></h3>
<p>This chapter covers:</p>
<ul>
<li>When and why resource management and control is necessary.</li>
<li>What a critical section is.</li>
<li>What mutual exclusion means.</li>
<li>What it means to suspend the scheduler.</li>
<li>How to use a mutex.</li>
<li>How to create and use a gatekeeper task.</li>
<li>What priority inversion is, and how priority inheritance can reduce
(but not remove) its impact.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../ch08/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../ch08/8.2-critical-sections-and-suspending-the-scheduler.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../ch08/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../ch08/8.2-critical-sections-and-suspending-the-scheduler.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
